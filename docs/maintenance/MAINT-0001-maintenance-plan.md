# MAINT-0001 — План сопровождения и стратегия обновлений

## Статус
- **Версия**: 1
- **Дата**: 2026-01-16
- **Шаг плана**:

## Цель

Определить воспроизводимый процесс обновлений Sigma-правил, датасетов, зависимостей и синхронизации с upstream Chainsaw с сохранением доказательной базы эквивалентности 1:1.

## Scope

Документ охватывает:
1. Обновление Sigma-правил
2. Обновление датасетов (EVTX)
3. Обновление C++ зависимостей (third_party)
4. Синхронизация с upstream Chainsaw
5. Сохранение доказательной базы 1:1

## Связанные документы

- `BASELINE-0001` — текущие baseline-версии upstream
- `GOV-0002` — критерии эквивалентности 1:1
- `LIC-0001` — лицензии upstream-источников
- `LIC-0002` — лицензии C++ зависимостей
- `POL-0001` — политика third-party компонентов
- `POL-0003` — политика тестовых данных
- `AR-0001` — архитектурные требования

---

## 1. Процесс обновления Sigma-правил

### 1.1. Триггеры обновления

- Выход новой версии/релиза SigmaHQ/sigma
- Обнаружение критичных багфиксов в правилах
- Добавление правил для новых угроз
- Запрос пользователя/заказчика

### 1.2. Процедура обновления

```
┌────────────────────────────────────────────────────────────┐
│ 1. ПОДГОТОВКА │
├────────────────────────────────────────────────────────────┤
│ a) Зафиксировать текущий baseline (commit SHA) │
│ b) Скачать новую версию sigma │
│ c) Извлечь git-метаданные: │
│ - git describe --tags --always │
│ - git rev-parse HEAD │
│ - git log -1 --date=iso-strict │
│ d) Вычислить SHA-256 архива │
└────────────────────────────────────────────────────────────┘
 │
 ▼
┌────────────────────────────────────────────────────────────┐
│ 2. ОЦЕНКА ИЗМЕНЕНИЙ │
├────────────────────────────────────────────────────────────┤
│ a) Diff между старой и новой версией │
│ b) Классификация изменений: │
│ - Добавленные правила (новые файлы) │
│ - Изменённые правила (модификации) │
│ - Удалённые правила │
│ - Изменения в структуре/формате │
│ c) Оценка влияния на 1:1 эквивалентность │
└────────────────────────────────────────────────────────────┘
 │
 ▼
┌────────────────────────────────────────────────────────────┐
│ 3. ТЕСТИРОВАНИЕ │
├────────────────────────────────────────────────────────────┤
│ a) Прогон unit-тестов Sigma (TST-SIGMA-*) │
│ b) Прогон golden runs с новыми правилами │
│ c) Diff-harness: сравнение с Rust │
│ d) Кроссплатформенное тестирование (3 VM) │
│ - Linux: GCC │
│ - macOS: AppleClang │
│ - Windows: MSVC │
└────────────────────────────────────────────────────────────┘
 │
 ▼
┌────────────────────────────────────────────────────────────┐
│ 4. ДОКУМЕНТИРОВАНИЕ │
├────────────────────────────────────────────────────────────┤
│ a) Обновить BASELINE-0001 (новый commit/describe) │
│ b) Обновить LIC-0001 (если изменилась лицензия) │
│ c) Создать отчёт обновления (REP-SIGMA-UPDATE-YYYY-MM-DD) │
│ d) Обновить 00_ARTIFACT_REGISTRY │
└────────────────────────────────────────────────────────────┘
 │
 ▼
┌────────────────────────────────────────────────────────────┐
│ 5. РАЗВЁРТЫВАНИЕ │
├────────────────────────────────────────────────────────────┤
│ a) Commit с сообщением: │
│ "Обновление Sigma до <version/describe>" │
│ b) Обновить upstream/sigma/ в репозитории │
│ c) Обновить фикстуры тестов (при необходимости) │
└────────────────────────────────────────────────────────────┘
```

### 1.3. Требования DRL 1.1 (POL-004)

При обновлении Sigma-правил **обязательно** сохранять:
- Поле `author` — не удалять, не перезаписывать
- Поля атрибуции: `id`, `references`, `related`, `tags`
- URI/ссылки на оригинальные правила
- Текст/ссылку на DRL 1.1

### 1.4. Чек-лист обновления Sigma

- Baseline зафиксирован (commit SHA + describe)
- SHA-256 архива сохранён
- Diff изменений проанализирован
- Unit-тесты PASS (TST-SIGMA-*)
- Golden runs PASS
- Кроссплатформенное тестирование PASS
- DRL 1.1 requirements соблюдены (author сохранён)
- BASELINE-0001 обновлён
- 00_ARTIFACT_REGISTRY обновлён
- Отчёт обновления создан

---

## 2. Процесс обновления датасетов (EVTX)

### 2.1. Триггеры обновления

- Выход новых EVTX-samples для новых техник атак
- Обнаружение проблем с существующими фикстурами
- Расширение тестового покрытия
- Запрос пользователя/заказчика

### 2.2. Типы датасетов (POL-0003)

| Категория | Описание | Размещение |
|-----------|----------|------------|
| **A** | Минимальные фикстуры для test-to-test | `cpp/tests/fixtures/` (коммитятся) |
| **B** | Расширенные фикстуры для integration tests | External артефакты (не коммитятся) |
| **C** | Полные датасеты для e2e | External артефакты (не коммитятся) |

### 2.3. Процедура обновления

```
┌────────────────────────────────────────────────────────────┐
│ 1. ПОДГОТОВКА │
├────────────────────────────────────────────────────────────┤
│ a) Определить категорию датасета (A/B/C) │
│ b) Проверить лицензию источника (GPL v3 для EVTX-SAMPLES) │
│ c) Зафиксировать provenance: │
│ - Upstream URL │
│ - Commit SHA / версия │
│ - SHA-256 файлов │
└────────────────────────────────────────────────────────────┘
 │
 ▼
┌────────────────────────────────────────────────────────────┐
│ 2. ПРОВЕРКА СОВМЕСТИМОСТИ │
├────────────────────────────────────────────────────────────┤
│ a) Загрузка датасета в C++ (dump/search/hunt) │
│ b) Сравнение с Rust на тех же данных │
│ c) Проверка границных условий (размер, формат) │
└────────────────────────────────────────────────────────────┘
 │
 ▼
┌────────────────────────────────────────────────────────────┐
│ 3. ИНТЕГРАЦИЯ │
├────────────────────────────────────────────────────────────┤
│ a) Для категории A: добавить в cpp/tests/fixtures/ │
│ b) Для категории B/C: сохранить как external artifact │
│ c) Обновить FIX-0001 (реестр фикстур) │
│ d) Добавить тесты, использующие новые данные │
└────────────────────────────────────────────────────────────┘
 │
 ▼
┌────────────────────────────────────────────────────────────┐
│ 4. ДОКУМЕНТИРОВАНИЕ │
├────────────────────────────────────────────────────────────┤
│ a) Обновить BASELINE-0001 (при обновлении EVTX-SAMPLES) │
│ b) Обновить 00_ARTIFACT_REGISTRY │
│ c) Создать отчёт (если значительные изменения) │
└────────────────────────────────────────────────────────────┘
```

### 2.4. Чек-лист обновления датасетов

- Лицензия проверена (GPL v3)
- Provenance зафиксирован (URL, commit, SHA-256)
- Категория определена (A/B/C)
- Совместимость с C++ проверена
- 1:1 эквивалентность подтверждена (Rust vs C++)
- FIX-0001 обновлён
- Тесты добавлены/обновлены
- BASELINE-0001 обновлён (при необходимости)

---

## 3. Процесс обновления C++ зависимостей

### 3.1. Текущие зависимости (LIC-0002)

| Компонент | Версия | Лицензия | Назначение |
|-----------|--------|----------|------------|
| RapidJSON | HEAD | MIT | JSON DOM + генерация |
| pugixml | v1.14 | MIT | XML парсинг |
| yaml-cpp | v0.8.0 | MIT | YAML парсинг |
| GoogleTest | v1.15.2 | BSD-3-Clause | Тестирование |

### 3.2. Триггеры обновления

- Критические security-патчи
- Bug fixes, влияющие на корректность
- Запрос пользователя/заказчика
- **НЕ обновлять** без явной необходимости (принцип стабильности)

### 3.3. Процедура обновления зависимости

```
┌────────────────────────────────────────────────────────────┐
│ 1. ОЦЕНКА НЕОБХОДИМОСТИ │
├────────────────────────────────────────────────────────────┤
│ a) Обоснование обновления (security/bugfix/feature) │
│ b) Анализ CHANGELOG/release notes │
│ c) Оценка breaking changes │
│ d) Создать ADR если значительное изменение │
└────────────────────────────────────────────────────────────┘
 │
 ▼
┌────────────────────────────────────────────────────────────┐
│ 2. ПРОВЕРКА ЛИЦЕНЗИИ │
├────────────────────────────────────────────────────────────┤
│ a) Лицензия не изменилась? → OK │
│ b) Лицензия изменилась? → Проверка совместимости с GPL v3 │
│ c) Обновить third_party/licenses/ если необходимо │
└────────────────────────────────────────────────────────────┘
 │
 ▼
┌────────────────────────────────────────────────────────────┐
│ 3. ИНТЕГРАЦИЯ │
├────────────────────────────────────────────────────────────┤
│ a) Обновить third_party/<component>/ │
│ b) Адаптировать код при API changes │
│ c) Собрать на 3 платформах (Linux/macOS/Windows) │
│ d) Прогнать полный набор тестов (505 unit tests) │
└────────────────────────────────────────────────────────────┘
 │
 ▼
┌────────────────────────────────────────────────────────────┐
│ 4. ВЕРИФИКАЦИЯ 1:1 │
├────────────────────────────────────────────────────────────┤
│ a) Diff-harness: сравнение с golden runs │
│ b) Проверка детерминизма (C7) │
│ c) Проверка форматов вывода (C2, C4, C5) │
│ d) Нет регрессий? → OK │
│ e) Есть регрессии? → Откат или исправление │
└────────────────────────────────────────────────────────────┘
 │
 ▼
┌────────────────────────────────────────────────────────────┐
│ 5. ДОКУМЕНТИРОВАНИЕ │
├────────────────────────────────────────────────────────────┤
│ a) Обновить LIC-0002 (новая версия) │
│ b) Обновить 00_ARTIFACT_REGISTRY │
│ c) Создать ADR если принято архитектурное решение │
│ d) Commit с сообщением: │
│ "Обновление <component> до <version>" │
└────────────────────────────────────────────────────────────┘
```

### 3.4. Чек-лист обновления зависимости

- Необходимость обновления обоснована
- Breaking changes проанализированы
- Лицензия проверена (совместима с GPL v3)
- Сборка на 3 платформах PASS
- Unit-тесты PASS (505/505)
- Diff-harness PASS (нет регрессий)
- LIC-0002 обновлён
- third_party/licenses/ обновлён (при необходимости)
- 00_ARTIFACT_REGISTRY обновлён
- ADR создан (при архитектурных изменениях)

---

## 4. Синхронизация с upstream Chainsaw

### 4.1. Стратегия синхронизации

**Текущий baseline**: Chainsaw v2.13.1 (commit `c692405ecbc9703d190a67fd0679e48961a99c3a`)

**Принципы**:
1. **Поведенческий порт** — портируем наблюдаемое поведение, а не код
2. **Управляемое обновление** — обновления baseline только по решению (ADR)
3. **Доказательная база** — каждое обновление требует пересъёма golden runs
4. **Кроссплатформенность** — обновления проверяются на всех 3 платформах

### 4.2. Типы upstream-изменений

| Тип | Описание | Действие |
|-----|----------|----------|
| **Bugfix** | Исправление ошибки в логике | Оценить, портировать если критично |
| **Security** | Исправление уязвимости | Приоритетное портирование |
| **Feature** | Новая функциональность | Отдельное решение (ADR), не автоматически |
| **Breaking** | Изменение CLI/форматов | Отдельное решение (ADR), новый baseline |
| **Internal** | Рефакторинг без изменения поведения | Игнорировать |

### 4.3. Процедура обновления baseline

```
┌────────────────────────────────────────────────────────────┐
│ 1. АНАЛИЗ UPSTREAM │
├────────────────────────────────────────────────────────────┤
│ a) Изучить git log между текущим baseline и target │
│ b) Классифицировать изменения (bugfix/security/feature) │
│ c) Оценить влияние на 1:1 критерии (GOV-0002) │
│ d) Создать ADR с обоснованием обновления │
└────────────────────────────────────────────────────────────┘
 │
 ▼
┌────────────────────────────────────────────────────────────┐
│ 2. ПОДГОТОВКА НОВОГО BASELINE │
├────────────────────────────────────────────────────────────┤
│ a) Скачать/checkout новую версию Chainsaw │
│ b) Собрать Rust на 3 платформах │
│ c) Пересъём golden runs (RUN-* на 3 платформах) │
│ d) Сохранить новые эталоны │
└────────────────────────────────────────────────────────────┘
 │
 ▼
┌────────────────────────────────────────────────────────────┐
│ 3. АДАПТАЦИЯ C++ ПОРТА │
├────────────────────────────────────────────────────────────┤
│ a) Анализ расхождений: старый Rust vs новый Rust │
│ b) Портирование изменений в C++ │
│ c) Обновление тестов (TST-*) │
│ d) Сборка на 3 платформах │
└────────────────────────────────────────────────────────────┘
 │
 ▼
┌────────────────────────────────────────────────────────────┐
│ 4. ВЕРИФИКАЦИЯ │
├────────────────────────────────────────────────────────────┤
│ a) Unit-тесты PASS │
│ b) Diff-harness: C++ vs новые golden runs │
│ c) Кроссплатформенное тестирование │
│ d) Parity-аудит (при необходимости) │
└────────────────────────────────────────────────────────────┘
 │
 ▼
┌────────────────────────────────────────────────────────────┐
│ 5. ДОКУМЕНТИРОВАНИЕ │
├────────────────────────────────────────────────────────────┤
│ a) Обновить BASELINE-0001 (новый commit/describe) │
│ b) Обновить upstream/chainsaw/ в репозитории │
│ c) Сохранить новые golden runs как артефакты │
│ d) Обновить все зависимые документы │
│ e) Закрыть ADR как Accepted │
└────────────────────────────────────────────────────────────┘
```

### 4.4. Чек-лист синхронизации с upstream

- ADR создан с обоснованием обновления
- Изменения классифицированы и проанализированы
- Rust собран на 3 платформах (новая версия)
- Golden runs пересняты на 3 платформах
- C++ адаптирован под изменения
- Unit-тесты PASS (все платформы)
- Diff-harness PASS (C++ vs новые golden runs)
- BASELINE-0001 обновлён
- upstream/chainsaw/ обновлён
- Golden runs сохранены как артефакты
- ADR закрыт (Accepted)

---

## 5. Сохранение доказательной базы 1:1

### 5.1. Структура доказательной базы (GOV-0002)

```
Доказательная база
├── As-Is спецификации (docs/as_is/)
│ ├── CLI-0001 — CLI-контракт
│ ├── FEAT-0001 — инвентарь фич
│ ├── ARCH-0001 — архитектура Rust
│ ├── DATA-0001 — форматы данных
│ └── DEPS-0001 — зависимости
├── Тестовая база (docs/tests/)
│ ├── TESTMAT-0001 — матрица тестов
│ └── FIX-0001 — реестр фикстур
├── Golden runs (external artifacts)
│ ├── rust_golden_runs_linux_x86_64/
│ ├── rust_golden_runs_macos_arm64/
│ └── rust_golden_runs_windows_x64/
├── Отчёты (docs/reports/)
│ ├── REP-0001 — Rust golden runs
│ ├── REP-0002..REP-0010 — верификация C++
│ └── VERIFY-SLICE-* — отчёты слайсов
└── Артефакты порта (cpp/)
 ├── src/ — исходный код
 └── tests/ — unit-тесты (505)
```

### 5.2. Инварианты доказательной базы

1. **Трассируемость**: REQ-* → MOD-* → TST-* → REP-*/RUN-*
2. **Платформенная полнота**: проверки на всех 3 платформах
3. **Детерминизм**: результаты воспроизводимы (C7)
4. **Согласованность**: документы не противоречат друг другу

### 5.3. Процедура поддержания доказательной базы

При любом изменении (Sigma/датасеты/зависимости/upstream):

```
┌────────────────────────────────────────────────────────────┐
│ ОБЯЗАТЕЛЬНЫЕ ПРОВЕРКИ │
├────────────────────────────────────────────────────────────┤
│ 1. Unit-тесты: 505/505 PASS на 3 платформах │
│ 2. Diff-harness: C++ vs golden runs (критерии C1-C7) │
│ 3. Детерминизм: повторные запуски идентичны │
│ 4. Документация: все изменения отражены │
└────────────────────────────────────────────────────────────┘
 │
 ▼
┌────────────────────────────────────────────────────────────┐
│ ПРИ РАСХОЖДЕНИЯХ │
├────────────────────────────────────────────────────────────┤
│ Вариант A: Исправить C++ (если ошибка в порте) │
│ Вариант B: Обновить golden runs (если изменился Rust) │
│ Вариант C: Создать ADR (если допустимое отклонение) │
│ Вариант D: Откатить изменение (если нарушает 1:1) │
└────────────────────────────────────────────────────────────┘
```

### 5.4. Архивирование и версионирование

| Артефакт | Хранение | Версионирование |
|----------|----------|-----------------|
| Исходный код | Git (коммиты) | Семантическое (major.minor.patch) |
| Документация | Git (коммиты) | По шагам плана (Step N) |
| Golden runs | External artifacts | По baseline (commit SHA) |
| Фикстуры (A) | Git (cpp/tests/fixtures/) | По SHA-256 файлов |
| Датасеты (B/C) | External artifacts | По baseline (commit SHA) |

---

## 6. Роли и ответственности

### 6.1. Maintainer (сопровождающий)

**Обязанности**:
- Мониторинг upstream (Chainsaw, Sigma, EVTX-SAMPLES)
- Оценка необходимости обновлений
- Проведение обновлений по процедурам
- Поддержание доказательной базы

**Квалификация**:
- Понимание критериев 1:1 (GOV-0002)
- Опыт работы с 3-VM протоколом
- Знание структуры проекта и документации

### 6.2. Security Officer (при необходимости)

**Обязанности**:
- Оценка security-патчей upstream
- Приоритизация критических обновлений
- Ревью security-аспектов изменений

### 6.3. Release Manager (при выпуске релизов)

**Обязанности**:
- Координация выпуска новых версий
- Обеспечение полноты документации
- Финальная верификация перед релизом

---

## 7. Частота и планирование обновлений

### 7.1. Рекомендуемая частота

| Компонент | Частота проверки | Триггер немедленного обновления |
|-----------|------------------|--------------------------------|
| Sigma rules | Ежемесячно | Critical detection rules |
| EVTX datasets | По необходимости | Новые техники атак |
| C++ зависимости | Ежеквартально | Security fixes |
| Upstream Chainsaw | По релизам | Security fixes, critical bugs |

### 7.2. Планирование обновлений

1. **Регулярные**: по расписанию (monthly/quarterly)
2. **Реактивные**: по security-инцидентам (ASAP)
3. **По запросу**: по требованию пользователей

---

## 8. Критерии отката изменений

### 8.1. Обязательный откат

- Unit-тесты FAIL (любое количество)
- Diff-harness FAIL (нарушение 1:1)
- Кроссплатформенность нарушена (сборка/тесты не проходят)
- Лицензионный конфликт

### 8.2. Рекомендуемый откат

- Значительное ухудшение производительности
- Увеличение размера бинарника >50%
- Сложность интеграции непропорциональна пользе

---

## Приложение A: Команды для типовых операций

### A.1. Обновление Sigma rules

```bash
# Скачать новую версию
git clone --depth 1 https://github.com/SigmaHQ/sigma.git sigma_new

# Извлечь метаданные
cd sigma_new
git describe --tags --always
git rev-parse HEAD
git log -1 --date=iso-strict

# Вычислить SHA-256
cd..
tar -czf sigma_new.tar.gz sigma_new/
sha256sum sigma_new.tar.gz
```

### A.2. Прогон тестов на 3 VM

```bash
# Linux
sshpass -p '12345' ssh user@192.168.5.75 'cd ~/cpp && cmake --build build && ctest --test-dir build'

# macOS
sshpass -p '12345' ssh yan@192.168.5.221 'cd ~/cpp && cmake --build build && ctest --test-dir build'

# Windows
sshpass -p '12345' ssh user@192.168.5.178 'cd C:\Users\user\cpp && cmake --build build --config Release && ctest --test-dir build -C Release'
```

### A.3. Diff-harness

```bash
python tools/harness/compare_behavior.py \
 --rust-golden golden/rust_golden_runs_linux_x86_64/ \
 --cpp-output out/cpp_runs_linux/ \
 --report docs/reports/DIFF-UPDATE-$(date +%Y-%m-%d).md
```

---

## Приложение B: Шаблон отчёта обновления

```markdown
# REP-UPDATE-YYYY-MM-DD — Отчёт обновления <компонент>

## Метаданные
- **Компонент**: Sigma / EVTX / <dependency> / Chainsaw
- **Старая версия**: <commit/version>
- **Новая версия**: <commit/version>
- **Дата**: YYYY-MM-DD

## Обоснование
<Причина обновления>

## Изменения
<Краткое описание изменений>

## Результаты тестирования

| Платформа | Компилятор | Тесты | Diff-harness |
|-----------|------------|-------|--------------|
| Linux | GCC | X/Y PASS | PASS/FAIL |
| macOS | AppleClang | X/Y PASS | PASS/FAIL |
| Windows | MSVC | X/Y PASS | PASS/FAIL |

## Влияние на 1:1

| Критерий | Статус | Комментарий |
|----------|--------|-------------|
| C1 (CLI) | PASS | |
| C2 (stdout/stderr) | PASS | |
| C3 (exit codes) | PASS | |
| C4 (детекты) | PASS | |
| C5 (файлы) | PASS | |
| C6 (ошибки) | PASS | |
| C7 (детерминизм) | PASS | |

## Обновлённые документы
- BASELINE-0001
- LIC-0001 / LIC-0002
- 00_ARTIFACT_REGISTRY
- <другие>

## Заключение
<PASS / FAIL с комментарием>
```

---

> Документ создан: 2026-01-16 ( — План сопровождения и стратегия обновлений)
