# PLAYBOOK-0001 — Шаблон артефактов одной итерации портирования

## Статус
- Версия: 1
- Статус: Accepted
- Создан:
- Назначение: определить обязательные выходы одной итерации портирования (–33) и критерии завершённости

## Цель

Этот документ — **операционный шаблон** (playbook), по которому определяется:
1. какие артефакты обязательны для каждой итерации портирования;
2. как проверить, что итерация завершена;
3. как связать итерацию с документами проекта (трассируемость, риски, ADR).

Playbook применяется к каждому слайсу из `docs/backlog/BACKLOG-0001-porting-backlog.md` на этапах:
- ** (Слайс-анализ)** — UnitReady
- ** (Слайс-реализация)** — изменения кода и тестов
- ** (Слайс-верификация)** — UnitDone

---

## Входы (для каждой итерации)

| Элемент | Источник |
|---------|----------|
| Идентификатор слайса (`SLICE-*`) | `docs/backlog/BACKLOG-0001-porting-backlog.md` |
| Наблюдаемая цель слайса | поле «Наблюдаемая цель» в BACKLOG-0001 |
| Связанные тесты (`TST-*`) | поле «TST-*» в BACKLOG-0001 → SoT `docs/tests/TESTMAT-0001-rust-test-matrix.md` |
| Связанные golden runs (`RUN-*`) | поле «RUN-*» в BACKLOG-0001 → SoT `docs/reports/REP-0001-rust-golden-runs.md` |
| Связанные модули (`MOD-*`) | поле «MOD-*» в BACKLOG-0001 → SoT `docs/architecture/TOBE-0001-cpp-to-be-architecture.md` |
| Связанные требования (`REQ-*`) | BACKLOG-0001 → → `docs/requirements/AR-0001-architectural-requirements.md` |
| Связанные решения (`ADR-*`/`DEC-*`) | |
| Связанные риски (`RISK-*`) | |
| Критерии эквивалентности | `docs/governance/GOV-0002-equivalence-criteria.md` |

---

## Артефакты итерации (обязательные выходы)

### 1. Micro-spec

**Назначение:** зафиксировать поведенческую истину Rust для слайса до начала реализации.

**Файл:** `docs/porting/SPEC-<SLICE-ID>.md`

**Обязательные секции:**

```markdown
# SPEC-<SLICE-ID> — Micro-spec для <название слайса>

## Метаданные
- SLICE-ID: <SLICE-*>
- MOD-*: <список модулей>
- TST-*: <список логических тестов>
- RUN-*: <список golden runs>
- REQ-*: <список требований>
- RISK-*: <связанные риски>

## Наблюдаемое поведение (FACTS)
<нумерованный список фактов с ссылками на источники: код/тесты/golden runs>

## Ожидаемые входы/выходы
<описание интерфейсов: аргументы CLI, форматы данных, exit codes, stdout/stderr>

## Критерий закрытия слайса
<конкретные проверки, необходимые для UnitDone>

## Зависимости
<какие SLICE-* должны быть закрыты до этого слайса>

## Ссылки
<ссылки на источники: Rust код, тесты, golden runs>
```

**Критерий готовности:** micro-spec прошёл UnitReady (см. ниже).

---

### 2. Изменения в коде

**Назначение:** реализовать поведение слайса в C++.

**Где:** `cpp/` (согласно To-Be архитектуре `docs/architecture/TOBE-0001-cpp-to-be-architecture.md`)

**Обязательные требования:**
1. Код компилируется на 3 платформах (Windows/Linux/macOS).
2. Код соответствует `docs/guide/GUIDE-0001-developer-guide.md`.
3. Код привязан к `MOD-*` из micro-spec.
4. Изменения трассируются к требованиям через комментарий в commit message или коде.

**Формат commit message:**
```
<SLICE-ID>: <краткое описание>

- <детали изменений>
- TST-*: <покрытые тесты>
- REQ-*: <покрытые требования>
```

---

### 3. Перенос/добавление тестов

**Назначение:** перенести тесты Rust (test-to-test) и/или добавить C++ тесты.

**Где:** `cpp/tests/` (с использованием GoogleTest, см. `ADR-0008`)

**Обязательные требования:**
1. Для каждого `TST-*` из micro-spec создан соответствующий C++ тест.
2. Имя теста содержит `TST-*` для трассируемости (рекомендуется формат `TEST_TST_NNNN_*`).
3. Тесты используют фикстуры из `cpp/tests/fixtures/` согласно `docs/licensing/POL-0003-test-data-policy.md`.
4. Тесты исполняются локально и в CI (`.github/workflows/ci.yml`).

**Файл отслеживания:** обновить секцию по слайсу/тестам.

---

### 4. Отчёт прогонов

**Назначение:** зафиксировать результаты запуска тестов и сборки на 3 платформах.

**Файл:** `docs/reports/RUN-<SLICE-ID>-<дата>.md`

**Обязательные секции:**

```markdown
# RUN-<SLICE-ID> — Отчёт прогонов

## Метаданные
- SLICE-ID: <SLICE-*>
- Дата: <YYYY-MM-DD>
- Платформы: Windows / Linux / macOS

## Результаты сборки

| Платформа | Компилятор | Результат | Примечания |
|-----------|------------|-----------|------------|
| Windows | MSVC... | PASS/FAIL |... |
| Linux | GCC... | PASS/FAIL |... |
| macOS | Clang... | PASS/FAIL |... |

## Результаты тестов

| Платформа | Тесты всего | Passed | Failed | Примечания |
|-----------|-------------|--------|--------|------------|
| Windows | N | N | 0 |... |
| Linux | N | N | 0 |... |
| macOS | N | N | 0 |... |

## CI ссылка
<ссылка на CI run (GitHub Actions) или указание "локальный прогон">

## Артефакты
<путь к логам сборки/тестов, если сохранены в.local/>
```

**Критерий:** все 3 платформы затронуты, сборка и тесты PASS.

---

### 5. Дифф-отчёт

**Назначение:** доказать 1:1 эквивалентность поведения Rust и C++ для сценариев слайса.

**Файл:** `docs/reports/DIFF-<SLICE-ID>-<дата>.md`

**Инструмент:** `tools/harness/compare_behavior.py` (см. ``)

**Обязательные секции:**

```markdown
# DIFF-<SLICE-ID> — Дифф-отчёт

## Метаданные
- SLICE-ID: <SLICE-*>
- Дата: <YYYY-MM-DD>
- Платформа сравнения: <Linux/Windows/macOS>

## Сценарии сравнения

| RUN-* | Критерий (C1–C7) | Результат | Примечания |
|-------|------------------|-----------|------------|
| | C2 (stdout), C3 (exit code) | PASS/FAIL |... |
|... |... |... |... |

## Детали расхождений (если есть)
<для каждого FAIL: что именно не совпало, Rust vs C++>

## Применённые нормализации
<если нормализация применялась — ссылка на ADR/DEC и описание>

## Вывод
<PASS: все критерии 1:1 выполнены / FAIL: перечислить незакрытые расхождения>
```

**Критерии (из GOV-0002):**
- C1: CLI-контракт
- C2: stdout/stderr (byte-to-byte)
- C3: exit codes
- C4: детекты/результаты анализа
- C5: файлы вывода
- C6: сообщения об ошибках
- C7: детерминизм

---

### 6. Обновление реестров (–33)

**Назначение:** поддерживать консистентность документации проекта.

**Обязательные обновления после каждой итерации:**

| Реестр | Что обновить |
|--------|--------------|
| | текущий слайс, статус, блокеры |
| | новые артефакты (SPEC, RUN, DIFF) |
| | связи `SLICE-* → TST-* → код` |
| | новые риски / закрытие существующих |
| | если принято новое решение ADR/DEC |
| `docs/backlog/BACKLOG-0001-porting-backlog.md` | статус слайса (Backlog → In Progress → Done) |

---

## Критерии завершённости итерации

### UnitReady ( — можно брать слайс в реализацию)

| # | Критерий | Проверка |
|---|----------|----------|
| 1 | Micro-spec создан | файл `docs/porting/SPEC-<SLICE-ID>.md` существует |
| 2 | Поведение описано на основе FACTS | секция «Наблюдаемое поведение» ссылается на код/тесты/golden runs |
| 3 | Определён полный набор проверок | перечислены `TST-*` и/или `RUN-*` для доказательства 1:1 |
| 4 | Зависимости оценены | перечислены required `SLICE-*` и их статус (Done или не блокирует) |
| 5 | Оценка S1–S4 корректна | не более одной оси High; если 2+ High — слайс дробится |

**Результат:** `UnitReady PASS` или `UnitReady FAIL` (с причиной).

---

### UnitDone ( — можно закрывать слайс)

| # | Критерий | Проверка |
|---|----------|----------|
| 1 | Код реализован | изменения в `cpp/` привязаны к `MOD-*` |
| 2 | Тесты портированы | для каждого `TST-*` есть C++ тест |
| 3 | Сборка на 3 платформах | отчёт прогонов: PASS на Windows/Linux/macOS |
| 4 | Тесты на 3 платформах | отчёт прогонов: 0 failed на всех платформах |
| 5 | Дифф-сравнение PASS | для всех `RUN-*` слайса критерии C1–C7 выполнены |
| 6 | Нет регрессий | ранее закрытые слайсы не сломаны (CI green) |
| 7 | Реестры обновлены | `00_*` и BACKLOG-0001 актуальны |
| 8 | Расхождения закрыты или оформлены | если FAIL — добавлен `RISK-*` или задача в backlog |

**Результат:** `UnitDone PASS` или `UnitDone FAIL` (с перечнем незакрытых критериев).

---

## Формат итогового отчёта итерации

После завершения (или при завершении серии –33) формируется итоговый блок в ответе:

```markdown
## Итог итерации <SLICE-*>

### UnitReady
- Статус: PASS/FAIL
- Micro-spec: `docs/porting/SPEC-<SLICE-ID>.md`

### Реализация
- Код: `cpp/src/<module>/...`
- Тесты: `cpp/tests/test_<module>_*.cpp`
- Commit: `<hash> — <message>`

### UnitDone
- Статус: PASS/FAIL
- Отчёт прогонов: `docs/reports/RUN-<SLICE-ID>-<дата>.md`
- Дифф-отчёт: `docs/reports/DIFF-<SLICE-ID>-<дата>.md`

### Обновления реестров
-: <что изменено>
-: <ART-* добавлены>
-: <связи добавлены>
-: <RISK-* добавлены/закрыты>
- `BACKLOG-0001`: <SLICE-* статус>
```

---

## Исключения и особые случаи

### Слайс без upstream тестов (`TST-*` пусто)

Если слайс не имеет upstream тестов:
1. Обязательны golden runs (`RUN-*`) для доказательства 1:1.
2. Рекомендуется добавить C++ unit-тесты для критических путей.
3. В micro-spec явно указать «TST-*: нет upstream тестов; покрытие через RUN-*».

### Слайс без golden runs (`RUN-*` пусто)

Если слайс не имеет golden runs:
1. Обязательны upstream тесты (`TST-*`) для test-to-test.
2. В micro-spec явно указать «RUN-*: нет golden runs; покрытие через TST-*».
3. Рассмотреть добавление сценариев в golden runs (обновить REP-0001).

### Блокирующий риск (High×2 по S1–S4)

Если слайс имеет High по 2+ осям S1–S4:
1. Слайс **не берётся в работу** до снижения неопределённости.
2. Создаётся план дробления или закрытия риска.
3. Статус в BACKLOG-0001: `Blocked (<RISK-*>)`.

### Расхождение поведения (дифф FAIL)

Если дифф показывает расхождение:
1. Проанализировать: баг в C++ или допустимое различие?
2. Если баг — исправить и повторить дифф.
3. Если допустимое различие — оформить ADR/DEC с обоснованием.
4. Если не удаётся закрыть — создать `RISK-*` и добавить задачу в backlog.
5. **Нельзя** помечать `UnitDone PASS` при незакрытых расхождениях.

---

## Ссылки

- Схема трассируемости: `docs/governance/GOV-0001-traceability-and-sot.md`
- Критерии эквивалентности: `docs/governance/GOV-0002-equivalence-criteria.md`
- Портинг-бэклог: `docs/backlog/BACKLOG-0001-porting-backlog.md`
- Test matrix Rust: `docs/tests/TESTMAT-0001-rust-test-matrix.md`
- Golden runs Rust: `docs/reports/REP-0001-rust-golden-runs.md`
- To-Be архитектура: `docs/architecture/TOBE-0001-cpp-to-be-architecture.md`
- Developer guide: `docs/guide/GUIDE-0001-developer-guide.md`
- Harness сравнения: `tools/harness/compare_behavior.py`
- Политика тестовых данных: `docs/licensing/POL-0003-test-data-policy.md`
- Plan (gates/микро-gates): разделы 2–3
- Операционные инструкции:
