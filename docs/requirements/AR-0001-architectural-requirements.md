# AR-0001 — Архитектурные требования (FR/NFR/SEC/OPS) для порта Chainsaw на C++

## Статус
- Версия: 1
- Статус: Draft (To‑Be)
- Baseline upstream: `BASELINE-0001` (см. `docs/baseline/BASELINE-0001-upstream.md`)
- Постановка задачи (SoT цели/границ): `TASK-0001` (см. `docs/requirements/TASK-0001-problem-statement.md`)
- Критерии эквивалентности 1:1 (SoT определения «совпало»): `GOV-0002` (см. `docs/governance/GOV-0002-equivalence-criteria.md`)
- Источники As‑Is (поведенческая истина Rust):
 - `CLI-0001` (см. `docs/as_is/CLI-0001-chainsaw-cli-contract.md`)
 - `FEAT-0001` (см. `docs/as_is/FEAT-0001-feature-inventory.md`)
 - `DATA-0001` (см. `docs/as_is/DATA-0001-data-formats-and-transformations.md`)
 - `DEPS-0001` (см. `docs/as_is/DEPS-0001-rust-dependencies.md`)
 - `TESTMAT-0001` (см. `docs/tests/TESTMAT-0001-rust-test-matrix.md`)
 - `REP-0001` (см. `docs/reports/REP-0001-rust-golden-runs.md`)
- Контекст ИБ‑домена: `docs/context/Ambrella_company_profile.docx`
- Риски/допущения (SoT неопределённостей):

---

## 0) Правила чтения этого документа

1) **AR — единственный источник истины для требований `REQ-*`.**
 В других документах (ADR/архитектура/планы/код/тесты) требования **не дублируются**, а только упоминаются по `REQ-*`.

2) AR **не делает To‑Be решений** (не выбирает библиотеки/архитектуру/формат модулей). Решения фиксируются в `ADR-*`/`DEC-*`.

3) Если требование упирается в открытый риск (например, отсутствие данных), это отражается ссылкой на `RISK-*` и планом верификации.

---

## 1) Классификация требований

- **FR** — функциональные требования (что делает инструмент и какие режимы поддерживает).
- **NFR** — нефункциональные требования (качества/инварианты: 1:1, детерминизм, кроссплатформенность).
- **SEC** — требования безопасности (устойчивость к недоверенным входам, контроль побочных эффектов).
- **OPS** — операционные требования (сборка/поставка/воспроизводимость, комплаенс лицензий и данных).

---

## 2) Требования FR (Functional Requirements)

### REQ-FR-0001 — Полный CLI‑контракт
**Требование:** C++ порт **должен** реализовать CLI‑контракт Chainsaw в объёме `CLI-0001` (команды/подкоманды, опции, дефолты, валидация аргументов, stdout/stderr, exit codes).

**Критерии приёмки:**
- Для всех CLI‑сценариев `…` из `REP-0001` наблюдаемое поведение совпадает с Rust по критериям `GOV-0002` (C1–C3, C6).

**Верификация:**
- diff‑harness по `…` (/33);
- дополнительные test‑to‑test проверки, если потребуются для аргпарсинга.

**Источники/обоснование:** `TASK-0001/2.1`, `CLI-0001`, `REP-0001`.

---

### REQ-FR-0002 — Команда `search`
**Требование:** C++ порт **должен** реализовать поведение `search` согласно `CLI-0001` и `FEAT-0007` (pattern/regex/tau, фильтры времени, таймзоны, форматы вывода).

**Критерии приёмки:**
- Пройдены проверки `TST-0001`, `TST-0002`, `TST-0003` (см. `TESTMAT-0001`).
- Для `…` (см. `REP-0001`) stdout/stderr/exit code совпадают с Rust по `GOV-0002`.

**Верификация:**
- test‑to‑test;
- diff‑harness по `…` (/33).

**Источники/обоснование:** `FEAT-0007`, `CLI-0001`, `TESTMAT-0001`, `REP-0001`.

---

### REQ-FR-0003 — Команда `hunt`
**Требование:** C++ порт **должен** реализовать поведение `hunt` согласно `CLI-0001` и `FEAT-0003` (детект по Chainsaw/Sigma правилам, mapping для Sigma, фильтры правил, форматы вывода, `--cache-to-disk`).

**Критерии приёмки:**
- Пройдена проверка `TST-0004` (см. `TESTMAT-0001`).
- Для `…` stdout/stderr/exit code и побочные артефакты совпадают с Rust по `GOV-0002` (включая C4/C5).

**Верификация:**
- test‑to‑test;
- diff‑harness по `…` (/33).

**Источники/обоснование:** `FEAT-0003`, `CLI-0001`, `REP-0001`.

Связанные риски: `RISK-0014` (побочные FS‑эффекты `--cache-to-disk`), `RISK-0011` (детерминизм вывода).

---

### REQ-FR-0004 — Команда `dump`
**Требование:** C++ порт **должен** реализовать поведение `dump` согласно `CLI-0001` и `FEAT-0002` для поддерживаемых форматов артефактов (см. `DATA-0001`) и режимов вывода (`Std/JSON/JSONL`).

**Критерии приёмки:**
- Для `…` stdout/stderr/exit code совпадают с Rust по `GOV-0002`.

**Верификация:**
- diff‑harness по `…` (/33);
- при необходимости — добавление test‑to‑test проверок на сериализацию.

**Источники/обоснование:** `FEAT-0002`, `CLI-0001`, `DATA-0001`, `REP-0001`.

---

### REQ-FR-0005 — Команда `lint`
**Требование:** C++ порт **должен** реализовать поведение `lint` согласно `CLI-0001` и `FEAT-0006` для поддерживаемых `--kind` значений baseline (chainsaw/sigma) и соответствующих ошибок/exit codes.

**Критерии приёмки:**
- Для `…` и `` stdout/stderr/exit code совпадают с Rust по `GOV-0002`.

**Верификация:**
- diff‑harness по `…`, `` (/33).

**Источники/обоснование:** `FEAT-0006`, `CLI-0001`, `REP-0001`.

---

### REQ-FR-0006 — `analyse srum`
**Требование:** C++ порт **должен** реализовать поведение `analyse srum` согласно `CLI-0001` и `FEAT-0011` (обработка `SRUDB.dat` + `SOFTWARE`, режим `--stats-only`, вывод в таблицу/JSON).

**Критерии приёмки:**
- Пройдены проверки `TST-0005` и `TST-0006` (см. `TESTMAT-0001`).
- Для `…` stdout/stderr/exit code и выходные файлы (если задействованы) совпадают с Rust по `GOV-0002`.

**Верификация:**
- test‑to‑test;
- diff‑harness по `…` (/33).

**Источники/обоснование:** `FEAT-0011`, `DATA-0001`, `TESTMAT-0001`, `REP-0001`.

---

### REQ-FR-0007 — `analyse shimcache`
**Требование:** C++ порт **должен** реализовать поведение `analyse shimcache` согласно `CLI-0001` и `FEAT-0010` (включая варианты с Amcache/regex/tspair), при наличии валидных входных данных.

**Критерии приёмки:**
- Добавлены и зафиксированы разрешённые фикстуры (SYSTEM hive, опционально Amcache) согласно политике данных.
- Добавлены `RUN-*` сценарии для shimcache и/или test‑to‑test проверки.
- Для этих сценариев результаты C++ совпадают с Rust по `GOV-0002`.

**Верификация:**
- новые `RUN-*` + diff‑harness (/33);
- или test‑to‑test при наличии upstream‑тестов/эквивалентных проверок.

**Источники/обоснование:** `FEAT-0010`, `CLI-0001`, `TASK-0001/3.2`.

Связанные риски: `RISK-0022` (нет входных данных).

---

### REQ-FR-0008 — Sigma правила: загрузка/конвертация/оптимизация
**Требование:** C++ порт **должен** реализовать семантику обработки Sigma правил (load/deserialize/convert to Tau, оптимизации выражений) на уровне наблюдаемого поведения Rust baseline.

**Критерии приёмки:**
- Пройдены проверки `TST-0007…TST-0022` (см. `TESTMAT-0001`).
- Дополнительно, `` (`lint --kind sigma -t`) совпадает по `GOV-0002`.

**Верификация:**
- test‑to‑test для `TST-0007…TST-0022`;
- diff‑harness по `` (/33).

**Источники/обоснование:** `FEAT-0005`, `DATA-0001/3.3`, `TESTMAT-0001`, `REP-0001`.

Связанные риски: `RISK-0006` (синхронизация sigma dataset), `RISK-0009` (атрибуция DRL vs 1:1 вывод).

---

### REQ-FR-0009 — Загрузка артефактов и трактовка форматов
**Требование:** C++ порт **должен** воспроизводить правила загрузки входных файлов и распознавания форматов из `DATA-0001` (extension-first, `--load-unknown` порядок fallback, `--skip-errors` семантика и тексты предупреждений).

**Критерии приёмки:**
- Сценарии, где задействованы `--load-unknown`/`--skip-errors` в golden runs и/или тестах, совпадают по `GOV-0002`.
- При отсутствии достаточного покрытия текущим набором `RUN-*`/`TST-*` должны быть добавлены дополнительные проверки в доказательную базу без изменения Rust baseline.

**Верификация:**
- расширение набора `RUN-*` (/28) или test‑to‑test согласно `TESTMAT-0001` и `DATA-0001`.

**Источники/обоснование:** `DATA-0001/2.2`, `CLI-0001`, `GOV-0002`.

---

## 3) Требования NFR (Non‑Functional Requirements)

### REQ-NFR-0010 — Эквивалентность 1:1 как измеримый инвариант
**Требование:** C++ порт **должен** удовлетворять критериям эквивалентности `GOV-0002` (C1–C7) для всего объёма, определённого `TASK-0001`.

**Критерии приёмки:**
- Все `TST-0001…TST-0022` из `TESTMAT-0001` закрыты эквивалентными проверками в C++ и проходят на целевых платформах.
- Все `RUN-*` сценарии из `REP-0001` сравниваются Rust vs C++ «внутри платформы» и проходят критерии `GOV-0002`.

**Верификация:**
- test‑to‑test (/33);
- golden runs + diff‑harness (/33);
- кроссплатформенный e2e‑валидатор.

**Источники/обоснование:** `TASK-0001/1`, `TASK-0001/3`, `GOV-0002`.

---

### REQ-NFR-0011 — Детерминизм в пределах платформы
**Требование:** Для сценариев, помеченных как повторяемые (repeats) в `REP-0001`, а также для дополнительно выбранных e2e сценариев, результаты C++ порта должны быть **детерминированы** (C7) и совпадать с детерминированным поведением Rust «внутри платформы».

**Критерии приёмки:**
- Для `…` (repeats=3) и иных сценариев, определённых в harness, сравнение повторов не выявляет расхождений stdout/stderr/exit code/файлов.

**Верификация:**
- diff‑harness с повторами и отчётами (/33).

**Источники/обоснование:** `GOV-0002/C7`, `REP-0001/4.3`, `RISK-0011`.

---

### REQ-NFR-0012 — Кроссплатформенность (Windows/Linux/macOS)
**Требование:** C++ порт **должен** собираться и проходить проверочную базу (минимум: unit/integration tests, а по мере готовности — e2e harness) на Windows, Linux и macOS.

**Критерии приёмки:**
- В CI (или воспроизводимых локальных прогонах, если CI недоступен) подтверждено успешное configure/build/test на каждой целевой ОС.
- Для каждой ОС выполняется сравнение с соответствующими Rust golden runs.. «внутри платформы».

**Верификация:**
- CI‑матрица + отчёты `REP-*` (/41).

**Источники/обоснование:** `TASK-0001/2.1.4`, `GOV-0002/1.2`.

---

### REQ-NFR-0013 — Масштаб входных данных на уровне baseline фикстур
**Требование:** C++ порт **должен** обрабатывать входные данные как минимум размеров/типов, присутствующих в baseline фикстурах и golden runs (например, SRUM `SOFTWARE` ~73MB, `SRUDB.dat` ~1.8MB, EVTX файлы).

**Критерии приёмки:**
- Сценарии `…`, `…`, `…` выполняются успешно (без аварийного завершения) и совпадают с Rust по `GOV-0002`.

**Верификация:**
- diff‑harness по соответствующим `RUN-*` (/33).

**Источники/обоснование:** `REP-0001/2.2`, `RISK-0003`.

---

### REQ-NFR-0014 — Трассируемость реализации к требованиям/тестам
**Требование:** Архитектура и реализация порта должны обеспечивать трассируемость по инварианту `REQ-* → (ADR-*/DEC-*) → MOD-* → TST-* → REP-*/RUN-*`.

**Критерии приёмки:**
- В и в To‑Be архитектуре представлены `MOD-*` границы и связи, замыкающие трассировку минимум для ключевых CLI‑поверхностей (`search/hunt/dump/analyse srum/lint`).

**Верификация:**
- аудит трассируемости;
- ревью архитектуры.

**Источники/обоснование:** `GOV-0001/4.2`, `TASK-0001/5.4`.

---

### REQ-NFR-0015 — Наблюдаемость stdout/stderr как bytes
**Требование:** C++ порт **должен** сохранять байтовую природу stdout/stderr (без неявного перекодирования/нормализаций) и воспроизводить переводы строк/пробелы/порядок строк как в Rust.

**Критерии приёмки:**
- diff‑harness сравнивает `stdout.bin`/`stderr.bin` byte‑to‑byte и не требует нормализаций, если они не разрешены отдельным решением согласно `GOV-0002/3`.

**Верификация:**
- дифф отчёты `REP-*` (/33).

**Источники/обоснование:** `GOV-0002/C2`, `REP-0001/3`.

---

### REQ-NFR-0016 — Отсутствие «улучшений» форматов без управляемого решения
**Требование:** Порт **не должен** вводить новые пользовательские возможности или менять форматы вывода/ошибок/exit codes относительно baseline `BASELINE-0001` без отдельного управляемого решения (`DEC-*`/`ADR-*`) и без обновления доказательной базы.

**Критерии приёмки:**
- Любое отклонение от Rust, обнаруженное diff‑harness, либо исправлено, либо оформлено как принятое решение с обновлением критериев/доказательств.

**Верификация:**
- diff‑harness (/33);
- аудит решений и изменений.

**Источники/обоснование:** `TASK-0001/2.2`, `GOV-0002/3`.

---

## 4) Требования SEC (Security Requirements)

### REQ-SEC-0017 — Недоверенные входы и устойчивость к ошибкам форматов
**Требование:** C++ порт **должен** рассматривать все входы (пути, EVTX/JSON/XML/HVE/MFT/ESEDB, YAML правил/маппингов) как недоверенные и обеспечивать безопасную обработку ошибок форматов без аварийных завершений процесса.

**Критерии приёмки:**
- Негативные сценарии из `REP-0001` (``, ``, ``) завершаются с теми же exit codes и сообщениями, что Rust (в пределах платформы).
- Для набора «битых»/некорректных входов, используемых в будущих fuzz/robustness тестах, процесс не падает (доказывается отдельным отчётом).

**Верификация:**
- negative golden runs + diff‑harness (/33);
- fuzz/robustness прогон (–36) с отчётом `REP-*`.

**Источники/обоснование:** `TASK-0001/1`, `GOV-0002/C6`, ИБ‑контекст.

---

### REQ-SEC-0018 — Контроль побочных эффектов файловой системы
**Требование:** Любые побочные эффекты в ФС (создание/перезапись файлов `--output`, временные файлы `--cache-to-disk`, извлечение MFT data streams) должны быть:
- **эквивалентны Rust** по наблюдаемому поведению (наличие/отсутствие файлов, содержимое, сообщения об ошибках);
- **безопасны по умолчанию** (не разрушать существующие данные за пределами описанного поведения).

**Критерии приёмки:**
- Для сценариев с файловыми эффектами в `RUN-*` (например, ``) дифф‑harness фиксирует совпадение создаваемых артефактов.
- Для сценариев MFT streams (если/когда включены в proof‑набор) соблюдаются инварианты `DATA-0001/2.7` (например, отказ при существующем output path).

**Верификация:**
- diff‑harness (/33) с сохранением `out_files/`;
- расширение набора `RUN-*` для MFT при закрытии `RISK-0025`.

**Источники/обоснование:** `GOV-0002/C5`, `DATA-0001/2.7`, `RISK-0014`, `RISK-0025`.

---

### REQ-SEC-0019 — Минимизация атакующей поверхности
**Требование:** Порт **не должен** добавлять новые внешние поверхности атаки по сравнению с Rust baseline:
- не вводить сетевые взаимодействия;
- не выполнять внешние команды/скрипты;
- не загружать плагины/код из данных.

**Критерии приёмки:**
- В кодовой базе порта отсутствуют зависимости/модули, вводящие указанные поверхности без отдельного решения (ADR) и без необходимости для 1:1.

**Верификация:**
- архитектурный и security‑ревью (/42);
- анализ зависимостей и их назначений.

**Источники/обоснование:** `TASK-0001/2.2` (non‑goals: не добавлять новые возможности), ИБ‑контекст.

---

### REQ-SEC-0020 — Безопасное управление временными файлами/каталогами
**Требование:** При создании временных файлов/каталогов (например, для `--cache-to-disk`) порт должен:
- избегать небезопасных предсказуемых имён;
- не оставлять мусор при ошибках там, где Rust его не оставляет (или оставляет — тогда эквивалентно);
- корректно обрабатывать права доступа/ошибки ФС.

**Критерии приёмки:**
- Сценарий `` совпадает по результатам и по побочным файлам с Rust.

**Верификация:**
- diff‑harness по `` (/33);
- дополнительные негативные сценарии (/28) при выявлении расхождений.

**Источники/обоснование:** `RISK-0014`, `GOV-0002/C5`.

---

### REQ-SEC-0021 — Защита от path traversal при генерации имён
**Требование:** Если порт генерирует имена файлов на основе входных путей/данных (например, MFT streams), он должен гарантировать, что итоговый путь остаётся внутри заданного output‑каталога и не допускает выход «вверх» (`..`) или запись в неожиданные места.

**Критерии приёмки:**
- В тестах/сценариях генерации файлов попытки внедрить `..`/абсолютные пути не приводят к записи вне целевого каталога.

**Верификация:**
- unit/security тесты на генерацию путей (/39).

**Источники/обоснование:** ИБ‑контекст, `DATA-0001/2.7` (генерация имён), `RISK-0025`.

---

### REQ-SEC-0022 — Отсутствие UB и проверяемая безопасность памяти
**Требование:** Реализация на C++ должна исключать неопределённое поведение при обработке недоверенных входов.

**Критерии приёмки:**
- В CI доступны и проходят сборки/прогоны с sanitizers (где поддерживается платформой) или эквивалентные проверки, покрывающие критические парсеры.

**Верификация:**
- инфраструктура качества + security testing + отчёты `REP-*`.

**Источники/обоснование:** ИБ‑контекст, `TASK-0001/1`.

---

## 5) Требования OPS (Operational Requirements)

### REQ-OPS-0023 — Воспроизводимая сборка и запуск (локально и в CI)
**Требование:** Для порта должен существовать воспроизводимый цикл `configure → build → test` на целевых платформах, пригодный для локальной разработки и CI.

**Критерии приёмки:**
- Developer guide содержит однозначные команды сборки/тестов.
- В CI этот цикл выполняется автоматически и выдаёт артефакты отчётов.

**Верификация:**
- CI логи;
- audit документации.

**Источники/обоснование:** `TASK-0001/4.3`, `RISK-0021` (ограничения Projects, требуется внешний воспроизводимый цикл).

---

### REQ-OPS-0024 — Доказательная инфраструктура и хранение артефактов
**Требование:** Проект должен поддерживать доказательную инфраструктуру `RUN-*`/`REP-*` и diff‑harness, обеспечивающую воспроизводимое сравнение Rust vs C++.

**Критерии приёмки:**
- Для каждого `RUN-*` существует отчёт `REP-*` с результатом сравнения, и артефакты (stdout/stderr/exit code/out_files + env/build) доступны как внешние артефакты (Projects/CI).

**Верификация:**
- /33/41 (harness и отчёты).

**Источники/обоснование:** `GOV-0002/4`, `REP-0001`, `TASK-0001/3`.

---

### REQ-OPS-0025 — Политика тестовых данных (размер/лицензии/воспроизводимость)
**Требование:** Должна быть определена и соблюдаться политика тестовых данных: что коммитится, что хранится во внешних артефактах, как фиксируются лицензии и checksums.

**Критерии приёмки:**
- Выполнен: политика оформлена документом и применена к фикстурам/датасетам.

**Верификация:**
- аудит политики и структуры репозитория (/42).

**Источники/обоснование:** `RISK-0003`, `POL-0001`.

---

### REQ-OPS-0026 — Лицензионный комплаенс и атрибуция
**Требование:** Порт и его поставка должны соответствовать политике лицензирования и атрибуции (`POL-0001`) и учитывать риски GPLv3/DRL.

**Критерии приёмки:**
- В репозитории присутствуют обязательные тексты лицензий и third‑party notices (минимум: `LICENSE`, `third_party/licenses/*`).
- Для каждой внешней зависимости/датасета присутствуют записи в реестрах лицензий.
- Любые изменения режима лицензирования оформлены управляемым решением (DEC/ADR).

**Верификация:**
- аудит лицензий;
- проверка артефактов репозитория.

**Источники/обоснование:** `POL-0001`, `LIC-0001`, `RISK-0008`, `RISK-0009`, `RISK-0010`.

---

### REQ-OPS-0027 — Управление версиями baseline входов (Chainsaw/Sigma/EVTX)
**Требование:** Для всех внешних baseline‑входов (Chainsaw, Sigma rules, EVTX samples) должны быть зафиксированы версии/происхождение так, чтобы результаты проверок были воспроизводимы.

**Критерии приёмки:**
- Для Chainsaw baseline это обеспечено `BASELINE-0001`.
- Для Sigma/EVTX baseline зафиксированы версии/commit/tag и связь с доказательствами.

**Верификация:**
- (baseline данных) + аудит.

**Источники/обоснование:** `RISK-0006`, `BASELINE-0001`, `REP-0001/2`.

---

### REQ-OPS-0028 — Поддержка air-gapped окружений
**Требование:** Сборка/тестирование/использование порта должны быть возможны в изолированных (air‑gapped) окружениях, т.е. без необходимости сетевого доступа в рантайме и с управляемым получением зависимостей/датасетов.

**Критерии приёмки:**
- В runbook/guide явно описано, какие артефакты должны быть предоставлены офлайн (архивы датасетов/эталоны) и как их использовать.

**Верификация:**
- ревью документации (/42);
- практический прогон в изолированной среде (по мере доступности).

**Источники/обоснование:** ИБ‑контекст, `RISK-0021`, `POL-0001`.

---

### REQ-OPS-0029 — Управление локальным состоянием и чистота артефактов
**Требование:** Репозиторий и снапшоты Projects не должны содержать локальные/временные данные сборки/прогонов (например, `.local/`, `build/`, `out/`, `inputs/tmp/`).

**Критерии приёмки:**
- Протокол упаковки снапшотов соблюдается; каталоги‑исключения отсутствуют в zip.

**Верификация:**
- ревью содержимого снапшотов + `.gitignore`.

**Источники/обоснование:** `DEC-0008`, правила Projects‑снапшотов в.

---

### REQ-OPS-0030 — Наличие runbook для внешних прогонов
**Требование:** Для всех проверок, которые нельзя выполнять в Projects‑среде, должен существовать runbook, позволяющий воспроизводимо получить артефакты и загрузить их в Projects/CI.

**Критерии приёмки:**
- Для Rust golden runs runbook уже зафиксирован (`REP-0001`, `tools/golden_runs_full/README.md`).
- Для C++ golden runs и diff‑harness будет зафиксирован аналогичный runbook.

**Верификация:**
- наличие/актуальность runbook документов;
- успешное получение артефактов в внешней среде.

**Источники/обоснование:** `RISK-0021`, `REP-0001/5`.

