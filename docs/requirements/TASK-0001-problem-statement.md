# TASK-0001 — Рабочая постановка задачи: портирование Chainsaw (Rust) → C++

## Статус
- Версия: 1
- Статус: Draft (To‑Be)
- Baseline upstream: `BASELINE-0001` (см. `docs/baseline/BASELINE-0001-upstream.md`)
- Критерии эквивалентности 1:1: `GOV-0002` (см. `docs/governance/GOV-0002-equivalence-criteria.md`)
- Источники As‑Is (поведенческая истина Rust):
 - CLI‑контракт: `CLI-0001` (см. `docs/as_is/CLI-0001-chainsaw-cli-contract.md`)
 - Реестр фич: `FEAT-0001` (см. `docs/as_is/FEAT-0001-feature-inventory.md`)
 - Форматы/пайплайны: `DATA-0001` (см. `docs/as_is/DATA-0001-data-formats-and-transformations.md`)
 - Матрица тестов: `TESTMAT-0001` (см. `docs/tests/TESTMAT-0001-rust-test-matrix.md`)
 - Golden runs протокол: `REP-0001` (см. `docs/reports/REP-0001-rust-golden-runs.md`)
- Риски/неясности: (ключевые: RISK-0003, RISK-0006, RISK-0008, RISK-0009, RISK-0011, RISK-0022, RISK-0028, RISK-0029)

---

## 1) Цель

Портировать Chainsaw (upstream Rust, baseline `BASELINE-0001`) на C++ так, чтобы при одинаковых входах и аргументах наблюдаемое поведение порта совпадало с Rust **1:1 в пределах платформы** (Windows/Linux/macOS) по критериям `GOV-0002`.

Под «наблюдаемым поведением» понимается (см. `GOV-0002`):
- exit code;
- stdout/stderr как байтовые потоки;
- создаваемые/изменяемые файлы и их содержимое;
- декларируемые CLI побочные эффекты.

## 2) Границы (Scope)

### 2.1. Входит в объём

1) **Полный объём поведения Chainsaw, описанный в As‑Is документах**, без «улучшений» и без изменения форматов:
 - CLI поверхность целиком: `CLI-0001`.
 - Функциональные режимы/фичи: `FEAT-0001`.
 - Форматы данных, инварианты преобразований и пайплайны: `DATA-0001`.

2) **Test‑to‑test сопоставимость** с upstream тестами Rust:
 - все логические тесты `TST-0001…TST-0022` из `TESTMAT-0001` должны иметь эквивалентную проверку в C++ (перенос тестов или эквивалентные проверки, если перенос невозможен).

3) **Golden runs / diff harness** как доказательная база:
 - сценарии `RUN-*` из `REP-0001` должны сравниваться Rust vs C++ «внутри платформы» (Windows↔Windows, Linux↔Linux, macOS↔macOS) согласно `GOV-0002`.

4) **Кроссплатформенность**:
 - сборка и проверка порта на Windows/Linux/macOS (детализация и механизм фиксации — в AR/ADR и шагах 24–26);
 - допускаются платформенные отличия Rust (ошибки ОС и т.п.) как часть «истины» платформы; сравнение проводится внутри платформы (см. `GOV-0002/1.2`).

### 2.2. Не входит в объём (явные non‑goals)

1) Добавление новых пользовательских возможностей, отсутствующих в baseline `BASELINE-0001`.
2) Изменение форматов вывода/ошибок/exit codes «ради удобства».
3) Оптимизации производительности до достижения функционального паритета и доказательства 1:1 (оптимизации допускаются только после parity и через harness; см. план –38).
4) Расширение/модификация набора Sigma правил и датасетов, влияющая на детекты, без фиксации как отдельного управляемого изменения (см. RISK-0006).
5) Продуктовая упаковка/дистрибуция (как финальная поставка) — предмет отдельных шагов плана (+), но требования к ней будут сформулированы в AR.

## 3) Сценарии и доказательства приёмки

Этот раздел определяет **набор сценариев**, по которым будет доказываться 1:1. Детальные критерии совпадения — в `GOV-0002`.

### 3.1. База test‑to‑test

**Обязательный набор:** все `TST-0001…TST-0022` из `TESTMAT-0001`.

Назначение:
- фиксирует неизменность семантики Sigma конвертации (TST-0007…TST-0022);
- фиксирует байт‑в‑байт совпадение stdout для ключевых CLI сценариев (TST-0001…TST-0006).

### 3.2. База golden runs (e2e сценарии)

**Обязательный набор:** все `RUN-*` сценарии из `REP-0001`.

Минимальные группы сценариев (категории):
- CLI meta/help/version и ошибки CLI: `…`.
- Поиск по EVTX: `…`.
- Hunt по rules: `…`.
- Dump (JSON/Std): `…`.
- Analyse SRUM: `…`.
- Lint Sigma: ``.

Примечания к покрытию:
- `analyse shimcache` (FEAT-0010) в baseline присутствует, но **не покрыт** `RUN-*` из‑за отсутствия входных данных; это зафиксировано как RISK-0022.
- Разнородность `--no-banner` в Windows эталонах и отсутствие banner‑эталона на Windows — RISK-0028.
- Отсутствие git‑метадаты в Windows эталонах — RISK-0029.

### 3.3. Минимальная карта «команда → доказательства»

| CLI поверхность | FEAT-* | Test-to-test (TST-*) | Golden runs (RUN-*) |
|---|---|---|---|
| Глобальные флаги (`--no-banner`, `--num-threads`, `-v`) | FEAT-0001 | (нет upstream тестов) |… (+ учитывать RISK-0028) |
| `search` | FEAT-0007, FEAT-0008, FEAT-0009 | TST-0001…TST-0003 |… |
| `hunt` | FEAT-0003, FEAT-0004, FEAT-0008, FEAT-0009 | TST-0004 |… |
| `dump` | FEAT-0002, FEAT-0008, FEAT-0009 | (нет upstream тестов) |… |
| `lint` | FEAT-0006 | (нет upstream тестов) |…, |
| `analyse srum` | FEAT-0011 | TST-0005…TST-0006 |… |
| `analyse shimcache` | FEAT-0010 | (нет upstream тестов) | (нет; RISK-0022) |

## 4) Ожидаемые артефакты (deliverables) проекта

Постановка фиксирует «что должно существовать» для управляемой реализации и доказуемой приёмки.

1) **Код порта (C++)**
 - исходники и сборочные файлы в каталоге `cpp/` (SoT реализации);
 - структура/границы/интерфейсы будут зафиксированы в To‑Be архитектуре, но на уровне постановки требуется, чтобы границы позволяли трассировку к `FEAT-*`/`TST-*`.

2) **Доказательная инфраструктура 1:1**
 - перенос тестов/эквивалентные тесты для `TST-*`;
 - harness дифф‑сравнения Rust vs C++ по `RUN-*` (/33);
 - отчёты `REP-*` по результатам проверок.

3) **Кроссплатформенный цикл сборки/проверки**
 - воспроизводимый configure/build/test цикл (локально и в CI) для Windows/Linux/macOS (–26);
 - правила качества и «зелёного состояния».

4) **Документация и управляемость**
 - AR, ADR, To‑Be, WBS, Developer guide;
 - реестры `00_*` обновляются на каждом шаге;
 - политика тестовых данных, учитывающая лицензии и воспроизводимость.

## 5) Что считается «готово» (Definition of Done на уровне продукта)

Проект считается завершённым (в рамках цели портирования), когда одновременно выполнены условия:

1) **Функциональный паритет доказан:**
 - все `TST-*` из `TESTMAT-0001` закрыты эквивалентными тестами и проходят в целевых ОС;
 - все `RUN-*` из `REP-0001` сравниваются через harness и удовлетворяют критериям `GOV-0002` (C1–C7) «внутри платформы».

2) **Критические риски по эквивалентности/воспроизводимости закрыты или приняты формально:**
 - нет открытых P1 рисков, влияющих на доказательство 1:1, либо они переведены в статус Accepted с явным обоснованием и компенсационными мерами.

3) **Кроссплатформенность подтверждена:**
 - сборка и тесты выполняются на Windows/Linux/macOS (через CI и/или воспроизводимые прогоны), без платформенных «дырок» в доказательной базе.

4) **Документация согласована и трассируемость замкнута:**
 - пройден финальный аудит консистентности;
 - для ключевых цепочек выполняется инвариант `REQ-* → (ADR-*/DEC-*) → MOD-* → TST-* → REP-*/RUN-*`.

## 6) Ограничения и открытые вопросы (через risk register)

Постановка не дублирует описания рисков, а фиксирует обязательство учитывать их в AR/ADR/To‑Be:

- RISK-0003: политика тестовых данных (размер/лицензии/воспроизводимость) — закрывается.
- RISK-0006: синхронизация Chainsaw ↔ Sigma/EVTX — закрывается (baseline/доказательства) либо принимается как ограничение.
- RISK-0008, RISK-0009, RISK-0010: лицензионные ограничения (GPLv3/DRL/SPDX) — должны быть учтены при проектировании поставки и политики данных.
- RISK-0011: детерминизм/окружение‑зависимость вывода — должен учитываться в harness и CI.
- RISK-0022: отсутствие данных для shimcache — требует получения/создания разрешённых фикстур или формального ограничения приёмки.
- RISK-0028, RISK-0029: качество Windows эталонов — требуются корректировки/пересъём или компенсационные меры в harness.

## 7) Трассируемость (минимальная)

- Scope и целевое поведение ↔ `CLI-0001`, `FEAT-0001`, `DATA-0001`.
- Test‑to‑test база ↔ `TESTMAT-0001` (`TST-*`).
- E2E сценарии ↔ `REP-0001` (`RUN-*`) + архивы `rust_golden_runs_*`….
- Определение 1:1 ↔ `GOV-0002` (C1–C7).
- Неясности/ограничения ↔ (RISK-*).

