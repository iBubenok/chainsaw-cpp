# ADR-0004 — Библиотека YAML (Sigma/Chainsaw rules и mappings)

## Статус
- Дата: 2026-01-02
- Статус: Accepted
- Контекст To‑Be: `TASK-0001`, `AR-0001`, `ARCH-0002`, `POL-0001`
- Связанные требования: `REQ-FR-0003`, `REQ-FR-0005`, `REQ-FR-0008`, `REQ-NFR-0010`, `REQ-NFR-0015`, `REQ-SEC-0017`, `REQ-OPS-0026`, `REQ-OPS-0028`
- Связанные риски: `RISK-0006`

## Контекст
YAML используется baseline Chainsaw для:
- загрузки Chainsaw rules и Sigma rules (см. `DEPS-0001`, `ARCH-0001`);
- загрузки mapping файлов;
- (в отдельных режимах) YAML‑вывода (см. `DATA-0001`).

Для Sigma действуют требования атрибуции (см. `POL-0001`, POL-004): необходимо сохранять метаданные правил (`author`, `id`, `references`, `related`, `tags` и т.п.), не «нормализуя» их так, чтобы потерять информацию.

Матрица вариантов `ARCH-0002` (категория B1) рассматривает: yaml-cpp, rapidyaml (ryml), libyaml.

## Решение
1) Принять **yaml-cpp** как базовую библиотеку YAML‑парсинга для реализации порта.

2) Разбор и валидация схемы считаются частью логики порта:
 - yaml-cpp используется для получения AST/узлов;
 - далее применяется собственная строгая валидация и нормализация, соответствующая поведению baseline Rust (включая тексты ошибок там, где они наблюдаемы).

3) Безопасность:
 - YAML входы рассматриваются как недоверенные (`REQ-SEC-0017`);
 - должны быть заданы лимиты (глубина/объём) и корректная обработка некорректных документов без падений (детали — в реализации и developer guide).

## Альтернативы
A) rapidyaml (ryml)
- Плюсы: высокая производительность, современный парсер.
- Минусы: потенциально иная трактовка YAML крайних случаев, что рискованно при 1:1.

B) libyaml (C)
- Плюсы: минималистичный C‑парсер.
- Минусы: низкоуровневый API, больше объём кода в порте для сопоставимых возможностей, выше риск ошибок при обработке сложных YAML.

## Обоснование
- yaml-cpp предоставляет зрелый API для разбора YAML, что снижает риск «самописного» парсинга.
- При 1:1 критична предсказуемость ошибок и возможность реализовать строгую схему поверх парсера. yaml-cpp позволяет построить собственный слой валидации, не полагаясь на неявные преобразования.
- Решение согласовано с `ADR-0002` (vendoring) и `REQ-OPS-0028` (офлайн сборка).

## Последствия
- В To‑Be архитектуре потребуется слой `rules_io`, который:
 - читает YAML через yaml-cpp;
 - выполняет нормализацию/валидацию;
 - гарантирует сохранение метаданных Sigma правил, требуемых `POL-0001`.
- Зависимость yaml-cpp должна быть отражена в реестре лицензий C++‑зависимостей (`LIC-0002`).

## План верификации
-: перенос/эквивалентные тесты `TST-0007…TST-0022` (конверсия Sigma → tau и модификаторы), которые чувствительны к YAML полям.
- /33: сценарии `` (lint Sigma) и сценарии `hunt`, зависящие от загрузки правил, сравнить через harness.

## Условия пересмотра
- Если тест‑к‑тесту база и/или diff‑harness покажут системные расхождения трактовки YAML (не устранимые на уровне нормализации/валидации).
- Если устойчивость yaml-cpp на недоверенных данных окажется недостаточной без существенных патчей.
