# ADR-0007 — Форматирование строк и внутреннее логирование

## Статус
- Дата: 2026-01-02
- Статус: Accepted
- Контекст To‑Be: `AR-0001`, `ARCH-0002`, `GOV-0002`
- Связанные требования: `REQ-NFR-0015`, `REQ-NFR-0016`, `REQ-SEC-0017`, `REQ-OPS-0028`
- Связанные риски: `RISK-0031`

## Контекст
Проект должен формировать stdout/stderr как байтовые потоки с точными сообщениями и форматами (см. `GOV-0002`).

В baseline Chainsaw сообщения формируются через макросы/утилиты (`anyhow` для ошибок, write-слой для печати) и завязаны на CLI-режимы verbose/quiet (см. `DEPS-0001`).

Матрица вариантов `ARCH-0002` (категории C4/C5) рассматривает, в частности, `fmt`, iostream и логирующие библиотеки (spdlog/Boost.Log).

## Решение
1) Принять **fmt** как базовую библиотеку форматирования строк в C++ порте.

2) **Не вводить стороннюю библиотеку логирования** (spdlog/Boost.Log) как обязательную зависимость.
 - пользовательские сообщения (stderr/stdout), включая verbose/quiet, остаются под контролем собственного слоя `cli/output` (см. `ADR-0006`);
 - внутренние диагностические сообщения (если появятся) должны быть выключаемыми и не влиять на 1:1 режим сравнения.

## Альтернативы
A) iostream / std::format
- Плюсы: стандартная библиотека.
- Минусы: iostream часто имеет неочевидные эффекты локали/формата и тяжёлый API; `std::format` и C++20‑зависимость увеличивают требования к toolchain.

B) spdlog (или Boost.Log)
- Плюсы: готовое логирование.
- Минусы: пользовательские сообщения baseline не совпадут “из коробки”; дополнительные зависимости и риск вмешательства в stderr.

## Обоснование
- fmt даёт предсказуемое и эффективное форматирование без привязки к локали iostream, что снижает риск отличий в сообщениях (`REQ-NFR-0015`).
- Отказ от стороннего логгера помогает удерживать контроль над stderr (критично для 1:1) и снижает зависимостную поверхность (см. `REQ-OPS-0028`).

## Последствия
- В коде порта должен быть единый модуль утилит форматирования/сообщений, который использует fmt, но выдаёт строки строго в формате baseline.
- fmt должна быть отражена в реестре лицензий C++‑зависимостей (`LIC-0002`) и подключаться через стратегию `ADR-0002`.

## План верификации
- /33: байтовое совпадение stderr/stdout в CLI‑сценариях `…` и функциональных `RUN-*` подтверждает, что использование fmt не изменяет наблюдаемые форматы.

## Условия пересмотра
- Если использование fmt окажется несовместимым с офлайн‑сборкой/целевыми toolchain при выполнении `ADR-0001/ADR-0002`.
- Если потребуется строго избежать любых внешних библиотек форматирования по причинам комплаенса/поставки.
