# ADR-0006 — CLI и пользовательский вывод (help/errors/таблицы/прогресс)

## Статус
- Дата: 2026-01-02
- Статус: Accepted
- Контекст To‑Be: `CLI-0001`, `GOV-0002`, `AR-0001`, `ARCH-0002`
- Связанные требования: `REQ-FR-0001`, `REQ-NFR-0015`, `REQ-NFR-0016`, `REQ-NFR-0011`, `REQ-SEC-0017`, `REQ-OPS-0027`
- Связанные риски: `RISK-0011`, `RISK-0028`, `RISK-0031`

## Контекст
Требование 1:1 включает байтовое совпадение stdout/stderr и exit codes (см. `GOV-0002`).
Baseline Chainsaw (Rust) строит CLI поверх `clap` и использует `prettytable-rs`, `indicatif`, `terminal_size` и `crossterm` для пользовательского вывода (см. `DEPS-0001`).

С практической точки зрения для порта это означает:
- генерация `--help/--version` и текстов ошибок CLI является частью наблюдаемого поведения;
- формат табличного вывода/CSV и наличие/отсутствие прогресс‑индикатора в stderr должны совпадать с baseline в сценариях `RUN-*`.

Матрица вариантов `ARCH-0002` (категории C2/C3/F) показывает, что прямые аналоги `clap/prettytable/indicatif` в C++ не гарантируют совпадения форматов и сообщений.

## Решение
1) **CLI‑парсер и сообщения:** реализовать **собственный слой CLI** в C++ (парсинг аргументов + рендеринг help/usage/error) так, чтобы:
- строки `--help`/`--version`, а также диагностические сообщения об ошибках совпадали с baseline согласно `CLI-0001` и `GOV-0002`;
- коды возврата и разделение stdout/stderr соответствовали baseline.

2) **Не полагаться на “готовые” help‑генераторы:** не использовать сторонние CLI‑библиотеки как источник help/usage/error сообщений (CLI11/cxxopts/Boost.Program_options и т.п.) в пользовательском выводе.

3) **Таблицы/CSV/JSON/JSONL и прочий пользовательский формат:** реализовать форматирование как часть кода порта и не привязывать совпадение к сторонним “табличным” библиотекам.

4) **Прогресс‑индикатор:** реализовать минимальный совместимый прогресс‑индикатор, который:
- по умолчанию ведёт себя как baseline при не‑TTY выводе (в golden runs stdout/stderr захватываются как bytes);
- учитывает флаги `--quiet/--verbose` и требования `REQ-NFR-0016`;
- различия символов Windows/non‑Windows фиксируются как часть платформенной истины (см. `ARCH-0001/4.1`).

## Альтернативы
A) Использовать CLI11/cxxopts и “подстроить” формат
- Плюсы: быстрее получить рабочий парсинг.
- Минусы: help/ошибки будут отличаться; потребуются глубокие хаки для 1:1 (см. `RISK-0031`).

B) Использовать готовую библиотеку таблиц/прогресса
- Плюсы: меньше кода.
- Минусы: формат вывода почти наверняка не совпадёт с baseline, а исправление будет сложнее, чем реализовать целевой формат напрямую.

## Обоснование
- CLI и текстовые форматы — это наиболее “видимая” часть 1:1. Любая зависимость, которая самостоятельно форматирует help/ошибки/таблицы, повышает риск недостижимого байтового совпадения.
- Собственный слой позволяет точно воспроизвести строки и правила форматирования, а также детерминировать вывод независимо от платформенных особенностей библиотек.
- Решение согласовано с `REQ-OPS-0027` (воспроизводимое сравнение) и с учётом известных рисков по CLI/help (`RISK-0031`) и Windows‑эталонам (`RISK-0028`).

## Последствия
- В To‑Be архитектуре должна появиться выделенная подсистема `cli`/`output`, отвечающая за:
 - парсинг argv;
 - печать help/version/usage;
 - нормализацию ошибок;
 - форматирование таблиц/CSV/прочих текстов;
 - политику печати прогресса (stderr).
- Потребуется отдельная тестовая база на CLI‑поверхность и пользовательские форматы (частично уже покрыто `…` и `TST-0001…TST-0006`).

## План верификации
-: CLI‑поверхность скелета должна соответствовать `CLI-0001` по командам/флагам и базовым кодам возврата (заглушки допустимы, но должны быть оформлены).
- /33: дифф‑сравнение по `…` (help/version/ошибки), а также сценариям, содержащим табличный вывод и JSON/JSONL.

## Условия пересмотра
- Если реализация собственного CLI приведёт к неприемлемой сложности и будет доказано, что сторонняя библиотека позволяет добиться 1:1 (с подтверждением через harness).
- Если изменится политика по поддерживаемым форматам вывода или будет принято отдельное решение о “допустимых отклонениях” (в этом случае пересмотр обязателен).
