# ADR-0005 — Regex‑движок для `search`/`hunt` и Sigma (RE2)

## Статус
- Дата: 2026-01-02
- Статус: Accepted
- Контекст To‑Be: `TASK-0001`, `AR-0001`, `ARCH-0002`, `DEPS-0001`
- Связанные требования: `REQ-FR-0002`, `REQ-FR-0008`, `REQ-SEC-0017`, `REQ-NFR-0010`, `REQ-NFR-0015`
- Связанные риски: `RISK-0011`

## Контекст
Baseline Chainsaw использует Rust crate `regex` и `RegexSet` для:
- поиска в `search` (см. `DEPS-0001`, `ARCH-0001`);
- поддержки части Sigma‑модификаторов и фильтрации (см. `DEPS-0001`).

Требуется:
- предсказуемая и безопасная семантика regex на недоверенных входах (`REQ-SEC-0017`);
- отсутствие катастрофического бэктрекинга (важно для больших логов и `REQ-NFR-0010`);
- управляемая и детерминированная обработка ошибок и совпадений для 1:1 вывода (`REQ-NFR-0015`).

Матрица вариантов `ARCH-0002` (категория C1) рассматривает: RE2, PCRE2, std::regex.

## Решение
1) Принять **RE2** как базовый regex‑движок в C++ порте.

2) Поведение regex, влияющее на 1:1, фиксируется уровнем‑обёрткой порта:
- синтаксические ограничения и тексты ошибок должны соответствовать baseline Chainsaw настолько, насколько это наблюдаемо (через `TST-*`/`RUN-*`);
- при несовпадении синтаксиса Rust regex и RE2 вводится совместимый слой (адаптация/валидация/раннее сообщение об ошибке).

## Альтернативы
A) PCRE2
- Плюсы: богатый синтаксис.
- Минусы: риск ReDoS/экспоненциального времени на некоторых паттернах; избыточно относительно Rust regex, который ограничен.

B) std::regex
- Плюсы: стандартная библиотека.
- Минусы: непредсказуемая производительность/качество реализации в libstdc++/libc++/MSVC; риск разной семантики и нестабильности на платформах.

## Обоснование
- Rust `regex` — движок без бэктрекинга и без поддержки ряда “тяжёлых” конструкций. RE2 ближе по классу семантики и гарантиям времени выполнения, чем PCRE2.
- RE2 снижает риск атак через regex (ReDoS) при обработке недоверенных логов и правил.
- RE2 поддерживает сценарии “множество паттернов” (аналог `RegexSet`) через составные решения в слое порта.

## Последствия
- В To‑Be архитектуре нужен модуль `regex`/`pattern` с единым API:
 - компиляция паттернов и наборов;
 - контроль флагов (case‑insensitive и т.п.);
 - нормализация ошибок для 1:1.
- RE2 должна быть отражена в реестре лицензий C++‑зависимостей (`LIC-0002`) и подключаться через стратегию `ADR-0002`.

## План верификации
-: перенос тестов, проверяющих семантику `search`/regex‑матчинга (см. `TESTMAT-0001`).
- /33: golden runs `…` (search по EVTX) должны совпадать по stdout/stderr/exit code согласно `GOV-0002`.

## Условия пересмотра
- Если дифф‑harness подтвердит системное несовпадение семантики regex (не исправляемое в слое адаптации) на критических сценариях baseline.
- Если интеграция RE2 в офлайн‑сборку окажется существенно сложнее альтернатив при сопоставимом риске (см. `ADR-0002`).
