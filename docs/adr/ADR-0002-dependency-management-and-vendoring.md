# ADR-0002 — Управление зависимостями C++ (vendoring, офлайн‑сборка)

## Статус
- Дата: 2026-01-02
- Статус: Accepted
- Контекст To‑Be: `TASK-0001`, `AR-0001`, `POL-0001`, `ARCH-0002`
- Связанные требования: `REQ-OPS-0026`, `REQ-OPS-0028`, `REQ-OPS-0029`, `REQ-SEC-0019`
- Связанные риски: `RISK-0008`, `RISK-0010`, `RISK-0032`

## Контекст
Проект должен:
- собираться/тестироваться воспроизводимо (см. `REQ-OPS-0023`);
- быть пригодным для air‑gapped окружений (см. `REQ-OPS-0028`);
- соблюдать комплаенс лицензий и атрибуции (см. `REQ-OPS-0026`, `POL-0001`);
- не расширять атакующую поверхность (см. `REQ-SEC-0019`).

Матрица вариантов `ARCH-0002` (категория F2) показывает, что любые решения по менеджеру зависимостей влияют на офлайн‑сборку и воспроизводимость, особенно при наличии C‑зависимостей (семейство libyal) и трёх целевых ОС (см. `RISK-0032`).

## Решение
1) **Основной режим:** использовать **vendoring исходников** зависимостей в репозитории порта с фиксацией версии (commit/tag) и контрольных сумм.

2) **Запрет сети по умолчанию:** конфигурация/сборка/тестирование **не должны требовать сетевого доступа**. Любой механизм получения зависимостей через сеть (FetchContent/внешний пакетный менеджер) допускается только как *опциональный* режим, который не является обязательным для CI и air‑gapped.

3) **Лицензии и атрибуция:**
- любые выбранные зависимости до включения их исходников в репозиторий должны быть отражены в отдельном реестре лицензий C++‑зависимостей (вводится как SoT: `docs/licensing/LIC-0002-cpp-dependencies.md`);
- тексты лицензий/NOTICE (если применимо) размещаются в `third_party/licenses/` согласно `POL-0001`.

## Альтернативы
A) vcpkg (manifest mode)
- Плюсы: готовые порты, удобная установка.
- Минусы: офлайн‑режим требует отдельной инфраструктуры (cache/mirror), повышает операционные риски и сложность воспроизводимости.

B) Conan
- Плюсы: гибкий менеджер, поддерживает бинарные кэши.
- Минусы: аналогично vcpkg — офлайн‑сценарии требуют отдельного контура; повышает риск “скрытой” сети и дрейфа зависимостей.

C) CMake FetchContent (скачивание на configure)
- Плюсы: минимальная ручная работа.
- Минусы: нарушает `REQ-OPS-0028` в базовом режиме; усложняет воспроизводимость и контроль версий/лицензий.

## Обоснование
- Vendoring даёт максимальный контроль над версией, содержимым и лицензией зависимости (важно для `REQ-OPS-0026`).
- Для Projects/CI и для air‑gapped окружений базовый режим без сети снижает операционные риски и соответствует требованиям безопасности (`REQ-SEC-0019`).
- Для C‑зависимостей (возможные libyal библиотеки) vendoring упрощает обеспечение одинаковых исходников на всех платформах и позволяет стандартизировать сборку через CMake (см. `ADR-0001`).

## Последствия
- Репозиторий может вырасти по размеру (компенсируется политикой данных и строгими правилами исключения мусора `REQ-OPS-0029`).
- Появляется обязанность вести:
 - реестр лицензий C++‑зависимостей (`LIC-0002`);
 - контроль версий/чек‑сумм для vendored исходников.
- Любые зависимости, требующие сложной системы сборки (autotools и т.п.), должны быть оценены на предмет влияния на кроссплатформенную сборку (см. `RISK-0032`).

## План верификации
-: C++‑скелет должен собираться из «чистого» состояния без сети, используя только содержимое репозитория.
-: CI матрица подтверждает воспроизводимость сборки на Windows/Linux/macOS.
-: аудит лицензий подтверждает наличие текстов лицензий/NOTICE и корректность записей в реестрах.

## Условия пересмотра
- Если выбранная зависимость технически невозможна к интеграции через vendoring без существенного ущерба кроссплатформенности/воспроизводимости.
- Если юридическая/продуктовая стратегия потребует иного режима распространения (см. `RISK-0008`).
